<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ZVENSKİ MAHKUMLARI - TCX Güncellemesi</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; background: #111; overflow: hidden; font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif; }
    canvas { display: block; background: #222; margin: auto; touch-action: none; }
    
    /* FPS Gösterge */
    #fpsCounter {
      position: absolute;
      top: 10px;
      left: 10px;
      color: #40E0D0;
      font-size: 16px;
      font-weight: bold;
      z-index: 1000;
      text-shadow: 0 0 5px rgba(0,0,0,0.8);
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 5px;
    }
    
    /* Ana Menü - Mobil uyumlu hale getirildi */
    #mainMenu {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle, #1a2a6c, #2c3e50);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      overflow: hidden;
    }
    
    .title-container {
      position: relative;
      margin-bottom: 5vh;
      animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-15px); }
    }
    
    .game-title {
      font-size: clamp(2rem, 8vw, 4.5rem);
      color: #ffd700;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.7),
                   0 0 20px rgba(255, 215, 0, 0.5),
                   0 0 30px rgba(255, 215, 0, 0.3);
      text-align: center;
      letter-spacing: 2px;
      text-transform: uppercase;
      font-weight: bold;
      padding: 0 10px;
    }
    
    .menu-btn {
      padding: 2vh 8vw;
      background: linear-gradient(to bottom, #27ae60, #219653);
      color: white;
      border: none;
      border-radius: 50px;
      font-size: clamp(1.2rem, 4vw, 1.8rem);
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3),
                 0 0 20px rgba(39, 174, 96, 0.5);
      text-transform: uppercase;
      letter-spacing: 1px;
      position: relative;
      overflow: hidden;
      margin: 1vh;
      min-width: 200px;
      max-width: 90%;
    }
    
    .menu-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 20px rgba(0, 0, 0, 0.4),
                 0 0 30px rgba(39, 174, 96, 0.7);
    }
    
    .menu-btn:active {
      transform: scale(0.95);
    }
    
    .menu-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: 0.5s;
    }
    
    .menu-btn:hover::before {
      left: 100%;
    }
    
    .prison-bars {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: 
        repeating-linear-gradient(
          90deg,
          transparent,
          transparent 20px,
          rgba(0, 0, 0, 0.3) 20px,
          rgba(0, 0, 0, 0.3) 40px
        );
      pointer-events: none;
      z-index: -1;
    }
    
    .floating-objects {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: -1;
    }
    
    .floating-object {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
    }
    
    /* Karakter Bilgi Ekranı - Mobil uyumlu */
    #charactersScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 150;
      color: white;
      overflow-y: auto;
      padding: 20px;
      padding-top: 70px;
    }
    
    .rarity-section {
      margin-bottom: 30px;
      width: 90%;
      max-width: 800px;
    }
    
    .rarity-title {
      font-size: clamp(1.5rem, 5vw, 2rem);
      margin-bottom: 15px;
      padding-bottom: 5px;
      border-bottom: 2px solid;
    }
    
    /* GÜNCELLENMİŞ RENKLER */
    .rarity-common { color: #bdc3c7; border-color: #bdc3c7; } /* 1. Enderlik - Gri */
    .rarity-epic { color: #3498db; border-color: #3498db; } /* 2. Enderlik - Mavi */
    .rarity-legendary { color: #e74c3c; border-color: #e74c3c; } /* 3. Enderlik - Kırmızı */
    .rarity-mythical { color: #FFD700; border-color: #FFD700; } /* 4. Enderlik - Parlak Sarı */
    
    .characters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .character-card {
      background: rgba(50, 50, 50, 0.7);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s;
      border: 2px solid;
    }
    
    .character-card.common { border-color: #bdc3c7; }
    .character-card.epic { border-color: #3498db; }
    .character-card.legendary { border-color: #e74c3c; }
    .character-card.mythical { border-color: #FFD700; }
    
    .character-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    
    .character-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      margin: 0 auto 10px;
      background-size: cover;
      border: 3px solid;
    }
    
    .character-avatar.common { border-color: #bdc3c7; }
    .character-avatar.epic { border-color: #3498db; }
    .character-avatar.legendary { border-color: #e74c3c; }
    .character-avatar.mythical { border-color: #FFD700; }
    
    .character-name {
      font-size: 1.1rem;
      margin-bottom: 5px;
    }
    
    .character-stats {
      font-size: 0.8rem;
      color: #ddd;
    }
    
    .close-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      font-size: 2.5rem;
      cursor: pointer;
      color: #e74c3c;
      transition: all 0.3s;
      z-index: 160;
      background: rgba(0,0,0,0.7);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:hover {
      transform: rotate(90deg);
    }
    
    /* Oyun Arayüzü */
    #gameUI { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
    .player-info { 
      position: absolute; color: white; font-size: 14px; 
      background: rgba(0, 0, 0, 0.7); padding: 5px 10px; 
      border-radius: 5px; white-space: nowrap;
      text-shadow: 1px 1px 2px black;
      transform: translate(-50%, 0);
      margin-top: -40px;
      z-index: 100;
    }
    
    /* Karakter Seçim Ekranı (mobil uyumlu) */
    #selectScreen {
      position: absolute; 
      top: 50%; 
      left: 50%; 
      transform: translate(-50%, -50%);
      width: 95%; 
      max-width: 800px;
      max-height: 90vh;
      background: #222; 
      color: white; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center; 
      gap: 20px; 
      z-index: 100;
      display: none;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
      padding: 20px;
      overflow-y: auto;
    }
    .selection-title {
      font-size: clamp(1.2rem, 4vw, 1.8rem);
      color: #f1c40f;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      margin-bottom: 10px;
      text-align: center;
    }
    .character-option { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px; 
      width: 100%;
    }
    .character { 
      padding: 10px; 
      border: 3px solid #444; 
      border-radius: 10px; 
      cursor: pointer; 
      text-align: center; 
      background: #333; 
      transition: all 0.3s;
      display: flex; 
      flex-direction: column; 
      align-items: center;
      pointer-events: auto;
    }
    .character:hover { transform: scale(1.05); border-color: #666; }
    .character.selected { border-color: #ffd700; box-shadow: 0 0 15px #ffd700; }
    .select-avatar {
      width: 50px; 
      height: 50px; 
      border-radius: 50%; 
      background-size: cover;
      margin-bottom: 8px; 
      border: 2px solid #555;
    }
    
    /* Geliştirilmiş Mobil Kontroller */
    .mobile-controls { 
      display: none; 
      position: absolute; 
      bottom: 20px; 
      width: 100%; 
      z-index: 100;
    }
    
    .player-controls {
      position: relative;
      width: 50%;
      height: 150px;
    }
    
    #player1Controls {
      float: left;
    }
    
    #player2Controls {
      float: right;
    }
    
    .joystick-container {
      position: absolute;
      width: 120px;
      height: 120px;
    }
    
    .joystick-base {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.4);
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
    }
    
    .joystick-thumb {
      position: absolute;
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 50%;
      top: 35px;
      left: 35px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.9);
      transition: transform 0.1s ease;
    }
    
    #moveJoystick1 { 
      left: 40px; 
      bottom: 40px;
    }
    
    #moveJoystick2 { 
      right: 40px; 
      bottom: 40px;
    }
    
    .ulti-btn {
      position: absolute; 
      width: 80px; 
      height: 80px; 
      border-radius: 50%;
      background: linear-gradient(145deg, #aa00ff, #7700cc);
      display: flex; 
      align-items: center; 
      justify-content: center;
      color: white; 
      font-weight: bold; 
      font-size: 16px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      border: 2px solid rgba(255, 255, 255, 0.6);
      pointer-events: auto;
      z-index: 101;
    }
    
    #ultiBtn1 {
      left: 40px;
      bottom: 180px;
    }
    
    #ultiBtn2 {
      right: 40px;
      bottom: 180px;
    }
    
    .ulti-btn.active {
      background: linear-gradient(145deg, #ff3300, #ff6600);
      box-shadow: 0 0 20px rgba(255, 102, 0, 0.7);
    }
    
    /* Oyun Sonu Ekranı */
    #gameOverScreen {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); display: none; flex-direction: column;
      align-items: center; justify-content: center; color: white; z-index: 50;
    }
    
    button { 
      padding: 12px 24px; 
      background: #4CAF50; 
      color: white; 
      border: none; 
      border-radius: 25px; 
      cursor: pointer; 
      font-size: 16px; 
      transition: all 0.3s; 
      margin: 10px;
      pointer-events: auto;
      min-width: 140px;
    }
    
    button:active {
      transform: scale(0.95);
    }

    .character-avatar.Bıdır {
      background: white url("data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20viewBox%3D%220%200%20300%20100%22%3E%0A%20%20%3Cpath%20d%3D%22M10%2C60%20Q20%2C20%2050%2C50%20T100%2C60%20Q120%2C80%20140%2C50%20Q160%2C30%20180%2C50%20T250%2C60%22%20%0A%20%20%20%20%20%20%20%20stroke%3D%22black%22%20stroke-width%3D%224%22%20fill%3D%22none%22%20stroke-linecap%3D%22round%22/%3E%0A%3C/svg%3E") center/60% no-repeat;
      border: 2px solid black;
    }
    .character-avatar.Biyot {
      background: #9b59b6 url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-2-3.5l7-4.5-7-4.5v9z'/%3E%3C/svg%3E") center/50% no-repeat;
      border: 2px solid #6c3483;
    }
    .character-avatar.Halk {
      background: #8e44ad url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23fff' d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm4.59-12.42L10 14.17l-2.59-2.58L6 13l4 4 8-8z'/%3E%3C/svg%3E");
      background-size: 50%;
      background-repeat: no-repeat;
      background-position: center;
      border: 2px solid #6c3483;
    }
    .character-avatar.AsimBurak {
      background: linear-gradient(135deg, #ff8c00 50%, #808080 50%);
      border: 2px solid #e74c3c;
    }
  
    @keyframes player-hit-flash {
      0% { filter: brightness(1); }
      50% { filter: brightness(2); }
      100% { filter: brightness(1); }
    }
    .hit-effect {
      animation: player-hit-flash 0.2s ease-in-out;
    }
    
    /* Yeni eklenen: Shader canvas için blend mode */
    #shaderCanvas {
      mix-blend-mode: screen;
      opacity: 0.8;
    }
    .light-beam {
      position: absolute;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(64,224,208,0.5) 0%, rgba(64,224,208,0) 70%);
      pointer-events: none;
      z-index: 5;
    }
    
    /* FPS Test Sonuç Ekranı */
    #fpsTestResult {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      z-index: 300;
      display: none;
      box-shadow: 0 0 30px rgba(64, 224, 208, 0.5);
      border: 2px solid #40E0D0;
      width: 90%;
      max-width: 500px;
    }
    
    .fps-category {
      font-size: 1.5rem;
      margin: 15px 0;
      padding: 10px;
      border-radius: 8px;
    }
    
    .fps-bad { background: rgba(255, 0, 0, 0.3); }
    .fps-ok { background: rgba(255, 165, 0, 0.3); }
    .fps-good { background: rgba(0, 255, 0, 0.3); }
    .fps-excellent { background: rgba(0, 200, 255, 0.3); }
    
    .close-test-btn {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 1.5rem;
      cursor: pointer;
      color: #e74c3c;
    }
    
    .fps-test-active #gameCanvas {
      filter: blur(3px);
    }
    
    .test-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: #40E0D0;
      font-size: 2rem;
      text-shadow: 0 0 10px rgba(0,0,0,0.8);
      z-index: 200;
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 10px;
      display: none;
    }
    
    /* TCX Işık Efektleri */
    .player-shadow {
      position: absolute;
      background: rgba(0, 0, 0, 0.35);
      z-index: 4;
      pointer-events: none;
    }
    
    /* Asım/Burak için özel efektler */
    .asim-slash {
      position: absolute;
      width: 80px;
      height: 30px;
      background: linear-gradient(90deg, rgba(255,140,0,0.7), rgba(255,69,0,0.9));
      border-radius: 50%;
      z-index: 20;
      pointer-events: none;
      box-shadow: 0 0 15px rgba(255,69,0,0.8);
      animation: slashEffect 0.3s ease-out forwards;
    }
    
    @keyframes slashEffect {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.2); }
      100% { opacity: 0; transform: scale(0.8); }
    }
    
    /* Envanter Ekranı */
    #inventoryScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 150;
      color: white;
      overflow-y: auto;
      padding: 20px;
      padding-top: 70px;
    }
    
    .inventory-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
      width: 90%;
      max-width: 1000px;
      margin-top: 30px;
    }
    
    .inventory-item {
      background: rgba(50, 50, 50, 0.7);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      transition: all 0.3s;
      border: 2px solid #40E0D0;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(64, 224, 208, 0.3);
    }
    
    .inventory-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(64, 224, 208, 0.5);
    }
    
    .item-image {
      width: 100px;
      height: 100px;
      margin: 0 auto 15px;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border: 2px solid #40E0D0;
      border-radius: 10px;
    }
    
    .item-name {
      font-size: 1.1rem;
      margin-bottom: 5px;
      color: #40E0D0;
      font-weight: bold;
    }
    
    .item-description {
      font-size: 0.9rem;
      color: #ddd;
      margin-top: 10px;
    }
    
    /* Yeni Kutu Efekti */
    .box-break-effect {
      position: absolute;
      width: 80px;
      height: 80px;
      background: radial-gradient(circle, #FFD700 0%, transparent 70%);
      border-radius: 10px;
      z-index: 20;
      pointer-events: none;
      animation: boxBreak 0.5s ease-out forwards;
    }
    
    @keyframes boxBreak {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(2); }
    }
    
    /* Cihaz tespiti için gizli element */
    #deviceInfo {
      position: absolute;
      top: -100px;
      left: -100px;
      width: 10px;
      height: 10px;
    }

    /* Ayarlar Ekranı */
    #settingsScreen {
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.9); 
      color: white; 
      z-index: 160; 
      display: none; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      padding: 20px;
    }

    /* Market Ekranı */
    #marketScreen {
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.95); 
      color: white; 
      z-index: 160; 
      display: none; 
      flex-direction: column; 
      align-items: center; 
      justify-content: center;
      padding: 20px;
    }

    /* Ateş Butonları */
    .fire-btn {
      position: absolute; 
      width: 80px; 
      height: 80px; 
      border-radius: 50%;
      background: linear-gradient(145deg, #ff3300, #ff6600);
      display: none; 
      align-items: center; 
      justify-content: center;
      color: white; 
      font-weight: bold; 
      font-size: 16px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      border: 2px solid rgba(255, 255, 255, 0.6);
      pointer-events: auto;
      z-index: 101;
    }
    
    #fireBtn1 {
      left: 40px;
      bottom: 270px;
    }
    
    #fireBtn2 {
      right: 40px;
      bottom: 270px;
    }
    
    .fire-btn:active {
      background: linear-gradient(145deg, #cc2900, #cc5200);
      transform: scale(0.95);
    }

    /* Mobil için özel stiller */
    @media (max-width: 768px) {
      .menu-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
      }
      
      .menu-btn {
        width: 80%;
        margin: 8px 0;
      }
      
      .character-option {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .characters-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .inventory-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .joystick-container {
        width: 100px;
        height: 100px;
      }
      
      .joystick-thumb {
        width: 40px;
        height: 40px;
        top: 30px;
        left: 30px;
      }
      
      #moveJoystick1 {
        left: 30px;
        bottom: 30px;
      }
      
      #moveJoystick2 {
        right: 30px;
        bottom: 30px;
      }
      
      .ulti-btn {
        width: 70px;
        height: 70px;
        font-size: 14px;
      }
      
      #ultiBtn1 {
        left: 30px;
        bottom: 150px;
      }
      
      #ultiBtn2 {
        right: 30px;
        bottom: 150px;
      }
      
      .fire-btn {
        width: 70px;
        height: 70px;
        font-size: 14px;
      }
      
      #fireBtn1 {
        left: 30px;
        bottom: 230px;
      }
      
      #fireBtn2 {
        right: 30px;
        bottom: 230px;
      }
    }

    @media (max-width: 480px) {
      .character-option {
        grid-template-columns: 1fr;
      }
      
      .characters-grid {
        grid-template-columns: 1fr;
      }
      
      .inventory-grid {
        grid-template-columns: 1fr;
      }
      
      .joystick-container {
        width: 80px;
        height: 80px;
      }
      
      .joystick-thumb {
        width: 30px;
        height: 30px;
        top: 25px;
        left: 25px;
      }
      
      #moveJoystick1 {
        left: 20px;
        bottom: 20px;
      }
      
      #moveJoystick2 {
        right: 20px;
        bottom: 20px;
      }
      
      .ulti-btn {
        width: 60px;
        height: 60px;
        font-size: 12px;
      }
      
      #ultiBtn1 {
        left: 20px;
        bottom: 120px;
      }
      
      #ultiBtn2 {
        right: 20px;
        bottom: 120px;
      }
      
      .fire-btn {
        width: 60px;
        height: 60px;
        font-size: 12px;
      }
      
      #fireBtn1 {
        left: 20px;
        bottom: 190px;
      }
      
      #fireBtn2 {
        right: 20px;
        bottom: 190px;
      }
    }
  </style>
</head>
<body>
  <div id="fpsCounter">FPS: 0</div>
  <div id="fpsTestResult">
    <span class="close-test-btn">&times;</span>
    <h2>FPS Test Sonuçları</h2>
    <div id="fpsValue">Ortalama FPS: 0</div>
    <div id="fpsCategory" class="fps-category"></div>
    <p>Test süresi: 5 saniye</p>
  </div>
  <div id="testIndicator" class="test-indicator">Test Çalışıyor...</div>
  
  <canvas id="shaderCanvas" width="2400" height="1800" style="position:absolute; top:0; left:0; z-index:10; display:none;"></canvas>
  <!-- Ana Menü -->
  <div id="mainMenu">
    <div class="prison-bars"></div>
    <div class="floating-objects" id="floatingObjects"></div>
    
    <div class="title-container">
      <h1 class="game-title">ZVENSKİ MAHKUMLARI</h1>
      <h2 style="color: #40E0D0; text-align: center; margin-top: 10px; font-size: clamp(1rem, 4vw, 1.5rem);">TCX GÜNCELLEMESİ</h2>
    </div>
    
    <div class="menu-buttons">
      <button class="menu-btn" id="playButton">OYNA</button>
      <button class="menu-btn" id="charactersButton">KARAKTERLER</button>
      <button class="menu-btn" id="inventoryButton">ENVANTER</button>
      <button class="menu-btn" id="settingsButton">AYARLAR</button>
      <button class="menu-btn" id="marketButton">MARKET</button>
    </div>
  </div>
  
  <!-- Karakter Bilgi Ekranı -->
  <div id="charactersScreen">
    <span class="close-btn" id="closeCharactersBtn">&times;</span>
    <h1>KARAKTERLER</h1>
    
    <div class="rarity-section">
      <h2 class="rarity-title rarity-mythical">Efsanevi (4. Enderlik)</h2>
      <div class="characters-grid" id="mythicalChars"></div>
    </div>
    
    <div class="rarity-section">
      <h2 class="rarity-title rarity-legendary">Ağır Savaşçılar (3. Enderlik)</h2>
      <div class="characters-grid" id="legendaryChars"></div>
    </div>
    
    <div class="rarity-section">
      <h2 class="rarity-title rarity-epic">Destansılar (2. Enderlik)</h2>
      <div class="characters-grid" id="epicChars"></div>
    </div>
    
    <div class="rarity-section">
      <h2 class="rarity-title rarity-common">Beleşçiler (1. Enderlik)</h2>
      <div class="characters-grid" id="commonChars"></div>
    </div>
  </div>
  
  <!-- Envanter Ekranı -->
  <div id="inventoryScreen">
    <span class="close-btn" id="closeInventoryBtn">&times;</span>
    <h1>ENVANTER</h1>
    <p style="margin-bottom: 20px; font-size: 1.2rem; color: #40E0D0;">Topladığınız çıkartmalar burada görüntülenir</p>
    
    <div class="inventory-grid" id="inventoryItems">
      <!-- Çıkartmalar burada görüntülenecek -->
    </div>
  </div>
  
  <!-- Karakter Seçim Ekranı (daha küçük) -->
  <div id="selectScreen">
    <h1 class="selection-title">1. Oyuncu Karakter Seçimi</h1>
    <div class="character-option" id="p1-select"></div>
    <h1 class="selection-title">2. Oyuncu Karakter Seçimi</h1>
    <div class="character-option" id="p2-select"></div>
    <button id="startButton">OYUNU BAŞLAT</button>
  </div>
  
  <!-- Oyun Alanı -->
  <canvas id="gameCanvas" width="2400" height="1800"></canvas>
  
  <!-- Ayarlar Ekranı -->
  <div id="settingsScreen">
    <span class="close-btn" id="closeSettingsBtn">&times;</span>
    <h1>AYARLAR</h1>
    
    <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 20px; align-items: center;">
      <div>
        <label style="font-size: 1.5rem; margin-right: 15px;">TCX:</label>
        <button id="toggleTCX" style="padding: 10px 20px; font-size: 1rem; border: none; border-radius: 10px; background: red; color: white;">KAPALI</button>
      </div>
      <div>
        <label style="font-size: 1.5rem; margin-right: 15px;">Grafik Ayarı:</label>
        <select id="graphicsLevel" style="padding: 10px; font-size: 1rem; border-radius: 10px;">
          <option value="low">Kıl Tablet</option>
          <option value="medium">Orta Cihaz</option>
          <option value="ultra">Ultra Yüksek</option>
        </select>
      </div>
      <div>
        <label style="font-size: 1.5rem; margin-right: 15px;">FPS Arttırıcı:</label>
        <button id="toggleFPS" style="padding: 10px 20px; font-size: 1rem; border: none; border-radius: 10px; background: red; color: white;">KAPALI</button>
      </div>
      <div>
        <button id="runFPSTest" style="padding: 12px 25px; background: #9b59b6; color: white; font-size: 1.2rem; border-radius: 10px;">FPS TESTİ ÇALIŞTIR</button>
      </div>
    </div>
  </div>
  
  <!-- Oyun Arayüzü -->
  <div id="gameUI"></div>
  
  <!-- Mobil Kontroller -->
  <div class="mobile-controls">
    <div id="player1Controls">
      <div class="joystick-container" id="moveJoystick1">
        <div class="joystick-base"></div>
        <div class="joystick-thumb"></div>
      </div>
      <div id="ultiBtn1" class="ulti-btn">ULTİ</div>
      <div id="fireBtn1" class="fire-btn">ATEŞ</div>
    </div>
    <div id="player2Controls">
      <div class="joystick-container" id="moveJoystick2">
        <div class="joystick-base"></div>
        <div class="joystick-thumb"></div>
      </div>
      <div id="ultiBtn2" class="ulti-btn">ULTİ</div>
      <div id="fireBtn2" class="fire-btn">ATEŞ</div>
    </div>
  </div>
  
  <!-- Oyun Sonu Ekranı -->
  <div id="gameOverScreen">
    <h1 id="winnerText"></h1>
    <button id="restartButton">TEKRAR OYNA</button>
  </div>

  <!-- Cihaz bilgisi için gizli element -->
  <div id="deviceInfo"></div>

  <!-- MARKET EKRANI -->
  <div id="marketScreen">
    <span class="close-btn" id="closeMarketBtn">&times;</span>
    <h1 style="margin-bottom: 20px; color: #FFD700;">MARKET</h1>
    <p style="font-size: 1.2rem; color: #ccc;">Sınırsız ücretsiz kutular açabilirsiniz</p>
    <button id="freeBoxButton" style="margin-top: 30px; padding: 20px 40px; font-size: 1.5rem; background: #40E0D0; color: black; border-radius: 15px; border: none; cursor: pointer; box-shadow: 0 0 20px #40E0D0;">ÜCRETSİZ KUTU AÇ</button>
    <p id="boxResult" style="margin-top: 30px; font-size: 1.3rem; color: #40E0D0;"></p>
  </div>

  <script>
    // Cihaz tespiti için değişkenler
    let deviceType = 'desktop'; // desktop, phone, tablet
    let screenSizeCategory = 'medium'; // small, medium, large, xlarge
    
    // Sayfa yüklendiğinde cihaz tespiti yap
    function detectDevice() {
      const ua = navigator.userAgent;
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      
      if (!isMobile) {
        deviceType = 'desktop';
        return;
      }
      
      // Ekran boyutuna göre cihaz tipini belirle
      const width = window.innerWidth;
      const height = window.innerHeight;
      const diagonal = Math.sqrt(width * width + height * height) / 96; // inç cinsinden
      
      if (diagonal < 5) {
        deviceType = 'phone';
        screenSizeCategory = 'small';
      } else if (diagonal < 7) {
        deviceType = 'phone';
        screenSizeCategory = 'medium';
      } else if (diagonal < 10) {
        deviceType = 'tablet';
        screenSizeCategory = 'large';
      } else {
        deviceType = 'tablet';
        screenSizeCategory = 'xlarge';
      }
      
      console.log(`Cihaz: ${deviceType}, Ekran: ${screenSizeCategory}, Çözünürlük: ${width}x${height}`);
    }
    
    // Ekran boyutuna göre UI ölçeklendirme
    function scaleUI() {
      if (deviceType === 'desktop') {
        // Masaüstü için özel ayarlar
        document.querySelector('.mobile-controls').style.display = 'none';
        document.querySelectorAll('.fire-btn').forEach(btn => {
          btn.style.display = 'none';
        });
        return;
      }
      
      // Mobil cihazlar için UI ölçeklendirme
      const controls = document.querySelector('.mobile-controls');
      controls.style.display = 'flex';
      controls.style.justifyContent = 'space-between';
      
      // Ateş butonlarını göster
      document.querySelectorAll('.fire-btn').forEach(btn => {
        btn.style.display = 'flex';
      });
      
      // Ekran boyutuna göre joystick boyutunu ayarla
      let joystickSize = 120;
      let thumbSize = 50;
      let offset = 40;
      
      if (screenSizeCategory === 'small') {
        joystickSize = 100;
        thumbSize = 40;
        offset = 30;
      } else if (screenSizeCategory === 'large' || screenSizeCategory === 'xlarge') {
        joystickSize = 140;
        thumbSize = 60;
        offset = 50;
      }
      
      // Joystick boyutlarını ayarla
      document.querySelectorAll('.joystick-container').forEach(container => {
        container.style.width = `${joystickSize}px`;
        container.style.height = `${joystickSize}px`;
      });
      
      document.querySelectorAll('.joystick-thumb').forEach(thumb => {
        thumb.style.width = `${thumbSize}px`;
        thumb.style.height = `${thumbSize}px`;
        thumb.style.top = `${(joystickSize - thumbSize) / 2}px`;
        thumb.style.left = `${(joystickSize - thumbSize) / 2}px`;
      });
      
      // Pozisyonları ayarla
      document.getElementById('moveJoystick1').style.left = `${offset}px`;
      document.getElementById('moveJoystick1').style.bottom = `${offset}px`;
      document.getElementById('moveJoystick2').style.right = `${offset}px`;
      document.getElementById('moveJoystick2').style.bottom = `${offset}px`;
      
      // Ulti buton boyutunu ve pozisyonunu ayarla
      const ultiBtnSize = joystickSize * 0.7;
      document.querySelectorAll('.ulti-btn').forEach(btn => {
        btn.style.width = `${ultiBtnSize}px`;
        btn.style.height = `${ultiBtnSize}px`;
      });
      
      document.getElementById('ultiBtn1').style.left = `${offset}px`;
      document.getElementById('ultiBtn1').style.bottom = `${offset + joystickSize + 20}px`;
      document.getElementById('ultiBtn2').style.right = `${offset}px`;
      document.getElementById('ultiBtn2').style.bottom = `${offset + joystickSize + 20}px`;
      
      // Ateş buton boyutunu ve pozisyonunu ayarla
      const fireBtnSize = joystickSize * 0.7;
      document.querySelectorAll('.fire-btn').forEach(btn => {
        btn.style.width = `${fireBtnSize}px`;
        btn.style.height = `${fireBtnSize}px`;
      });
      
      document.getElementById('fireBtn1').style.left = `${offset}px`;
      document.getElementById('fireBtn1').style.bottom = `${offset + joystickSize + ultiBtnSize + 40}px`;
      document.getElementById('fireBtn2').style.right = `${offset}px`;
      document.getElementById('fireBtn2').style.bottom = `${offset + joystickSize + ultiBtnSize + 40}px`;
    }

    // Envanter sistemi
    let inventory = [];
    const stickers = [
      { id: 1, name: "TCX", image: "TCX.png.png", description: "TCX Premium Sticker" },
      { id: 2, name: "TCX PRO", image: "TCX PRO.png", description: "TCX Pro Premium Sticker" }
    ];
    
    // Envanter ekranını güncelle
    function renderInventory() {
      const container = document.getElementById('inventoryItems');
      container.innerHTML = '';
      
      if (inventory.length === 0) {
        container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; font-size: 1.5rem; color: #ccc;">Henüz hiç çıkartma toplamadınız!</p>';
        return;
      }
      
      inventory.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'inventory-item';
        itemElement.innerHTML = `
          <div class="item-image" style="background-image: url('${item.image}')"></div>
          <div class="item-name">${item.name}</div>
          <div class="item-description">${item.description}</div>
        `;
        container.appendChild(itemElement);
      });
    }
    
    // Envantere çıkartma ekle
    function addToInventory(stickerId) {
      const sticker = stickers.find(s => s.id === stickerId);
      if (sticker && !inventory.some(i => i.id === stickerId)) {
        inventory.push(sticker);
        renderInventory();
      }
    }

    // FPS hesaplama için değişkenler
    let lastFpsUpdate = 0;
    let frameCount = 0;
    let fps = 0;
    let fpsBoosterEnabled = false;
    let fpsTestActive = false;
    let fpsTestStart = 0;
    let fpsTestFrames = 0;
    let fpsTestResults = [];
    let tcxEnabled = false;
    let ultraMapInitialized = false;
    let shaderInitialized = false;
    let glCanvas = document.getElementById("shaderCanvas");
    let gl = glCanvas.getContext("webgl");
    let lightPositions = [];
    let playerLightData = [0, 0]; // Player light intensities

    // Blok tipleri ve renkleri
    const BLOCK_TYPES = {
      STONE: { color: "#8B4513", unbreakable: true },
      GLASS: { color: "rgba(64, 224, 208, 0.7)", breakable: true },
      WATER: { color: "rgba(30, 144, 255, 0.6)", slowdown: 0.5 },
      LIGHT: { color: "#40E0D0", lightSource: true, intensity: 2.0 }, // Turkuaz renk
      BOX: { color: "#FFD700", breakable: true, health: 3, drop: true } // Yeni kutu blokları
    };

    const BLOCK_SIZE = 40;
    let blocks = []; // Değişken yapıldı

    // Yüzen nesneler oluştur
    function createFloatingObjects() {
      const container = document.getElementById('floatingObjects');
      container.innerHTML = ''; // Önceki nesneleri temizle
      const count = fpsBoosterEnabled ? 10 : 20; // FPS arttırıcı açıksa daha az nesne
      
      for (let i = 0; i < count; i++) {
        const obj = document.createElement('div');
        obj.classList.add('floating-object');
        
        // Rastgele boyut (10px - 50px)
        const size = Math.random() * 40 + 10;
        obj.style.width = `${size}px`;
        obj.style.height = `${size}px`;
        
        // Rastgele konum
        const left = Math.random() * 100;
        const top = Math.random() * 100;
        obj.style.left = `${left}%`;
        obj.style.top = `${top}%`;
        
        // Rastgele animasyon
        const duration = Math.random() * 10 + 15;
        const delay = Math.random() * 5;
        obj.style.animation = `float ${duration}s ease-in-out ${delay}s infinite`;
        
        container.appendChild(obj);
      }
    }

    // Karakter bilgi ekranını oluştur
    function renderCharactersScreen() {
      const commonChars = ['Boksör', 'Pro', 'Ali'];
      const epicChars = ['Mısır', 'Bıdır'];
      const legendaryChars = ['Hett', 'Asım/Burak'];
      const mythicalChars = ['Halk', 'Biyot'];
      
      // Beleşçiler (1. Enderlik)
      const commonContainer = document.getElementById('commonChars');
      commonContainer.innerHTML = '';
      characters.filter(c => commonChars.includes(c.name)).forEach(char => {
        const card = createCharacterCard(char, 'common');
        commonContainer.appendChild(card);
      });
      
      // Destansılar (2. Enderlik)
      const epicContainer = document.getElementById('epicChars');
      epicContainer.innerHTML = '';
      characters.filter(c => epicChars.includes(c.name)).forEach(char => {
        const card = createCharacterCard(char, 'epic');
        epicContainer.appendChild(card);
      });
      
      // Ağır Savaşçılar (3. Enderlik)
      const legendaryContainer = document.getElementById('legendaryChars');
      legendaryContainer.innerHTML = '';
      characters.filter(c => legendaryChars.includes(c.name)).forEach(char => {
        const card = createCharacterCard(char, 'legendary');
        legendaryContainer.appendChild(card);
      });
      
      // Efsanevi (4. Enderlik)
      const mythicalContainer = document.getElementById('mythicalChars');
      mythicalContainer.innerHTML = '';
      characters.filter(c => mythicalChars.includes(c.name)).forEach(char => {
        const card = createCharacterCard(char, 'mythical');
        mythicalContainer.appendChild(card);
      });
    }

    // Karakter kartı oluştur
    function createCharacterCard(char, rarity) {
      const card = document.createElement('div');
      card.className = `character-card ${rarity}`;
      
      const avatar = document.createElement('div');
      avatar.className = `character-avatar ${char.name.replace(/\s+/g, '')} ${rarity}`;
      avatar.style.backgroundColor = char.color;
      
      const name = document.createElement('div');
      name.className = 'character-name';
      name.textContent = char.name;
      
      const stats = document.createElement('div');
      stats.className = 'character-stats';
      stats.innerHTML = `
        <p>❤️ ${char.health} Can</p>
        <p>🔫 ${char.damage} Hasar</p>
        <p>⚡ ${char.ultRequired} Vuruşta Ulti</p>
        <p>🔄 ${char.reloadSpeed}s Dolum</p>
      `;
      
      card.appendChild(avatar);
      card.appendChild(name);
      card.appendChild(stats);
      
      return card;
    }

    // Oyun Ayarları
    const config = {
      width: 2400,
      height: 1800,
      mobileThreshold: 768,
      isMobile: window.innerWidth <= 768,
      baseReloadTime: 2000,
      maxAmmo: 3,
      healthRegenDelay: 8000,
      healthRegenInterval: 1000
    };

    // Karakterler
    const characters = [
      {
        id: 9,
        name: "Asım/Burak",
        health: 1000,
        maxHealth: 1000,
        damage: 300,
        ultRequired: 4,
        reloadSpeed: 1, // 1.2'den 1 saniyeye düşürüldü
        color: "#FFA500", // Turuncu
        size: 32,
        speed: 7.5, // Normal karakterin 2.5 katı hız
        bulletSpeed: 0,
        bulletSize: 0,
        bulletRange: 40, // Bıçak menzili
        ultDuration: 15000, // 15 saniye
        // Mod bilgisi: 1=Asım, 2=Burak
        currentMode: 1,
        // Asım modu özellikleri
        asimMode: {
          color: "#FFA500",
          health: 1000,
          maxHealth: 1000,
          damage: 300,
          speed: 7.5,
          bulletRange: 40
        },
        // Burak modu özellikleri
        burakMode: {
          color: "#808080",
          health: 1000, // Geçiş anındaki can
          maxHealth: 2000,
          damage: 0,
          speed: 4.5, // Normal hız
          bulletRange: 0
        },
        // Ulti dolum süreleri
        ultiCooldownAsim: 20000, // Asım modunda ulti 20 saniyede dolar
        ultiCooldownBurak: 15000, // Burak modunda ulti 15 saniyede dolar (otomatik)
        // Zamanlayıcılar
        modeSwitchTime: 0, // Mod değiştirme zamanı
        lastHealTime: 0 // Burak modunda can yenileme zamanı
      },
      {
        id: 6,
        name: "Halk",
        health: 1200,
        maxHealth: 1200,
        damage: 400,
        ultRequired: 5,
        reloadSpeed: 4,
        color: "#8e44ad",
        size: 32,
        speed: 4.5,
        bulletSpeed: 35,
        bulletSize: 8,
        bulletRange: 1560,
        ultDuration: 5000,
        homingFactor: 0.3,
        originalSpeed: 4.5
      },
      {
        id: 7,
        name: "Mısır",
        health: 2000,
        maxHealth: 2000,
        damage: 100,
        ultRequired: 8,
        reloadSpeed: 1.8,
        color: "#FFD700",
        size: 38,
        speed: 4.8,
        bulletSpeed: 70,
        bulletSize: 12,
        bulletRange: 900,
        ultDuration: 7000,
        originalSpeed: 4.8,
        auraRadius: 200,
        ultRadius: 600,
        isUltActive: false
      },
      {
        id: 5,
        name: "Bıdır",
        health: 1500,
        maxHealth: 1500,
        damage: 250,
        ultRequired: 5,
        reloadSpeed: 1.5,
        color: "#ffffff",
        size: 35,
        speed: 4,
        bulletSpeed: 60,
        bulletSize: 8,
        bulletRange: 450,
        ultRadius: 750,
        ultDuration: 5000,
        originalSpeed: 4,
        originalDamage: 250,
        originalReloadSpeed: 1.5,
        specialAbilityActive: false
      },
      {
        id: 4,
        name: "Boksör",
        health: 2500,
        maxHealth: 2500,
        damage: 500,
        ultRequired: 3,
        reloadSpeed: 1.2,
        color: "#2ecc71",
        size: 35,
        speed: 4,
        bulletSpeed: 50,
        bulletSize: 20,
        bulletRange: 80,
        ultDuration: 5000
      },
      {
        id: 3,
        name: "Hett",
        health: 1200,
        maxHealth: 1200,
        damage: 150,
        ultRequired: 1,
        reloadSpeed: 2.5,
        color: "#ffffff",
        size: 30,
        speed: 5,
        bulletSpeed: 75,
        bulletSize: 6,
        bulletRange: 1200,
        dashCooldown: 4000,
        specialAmmo: 0,
        maxAmmo: 3,
        direction: 1,
        lastDash: 0
      },
      {
        id: 1,
        name: "Ali",
        health: 1400,
        maxHealth: 1400,
        damage: 300,
        ultRequired: 5,
        reloadSpeed: 1.5,
        color: "#3498db",
        size: 30,
        speed: 5,
        bulletSpeed: 15,
        bulletSize: 12,
        bulletRange: 500,
        ultDuration: 5000
      },
      {
        id: 2,
        name: "Pro",
        health: 1700,
        maxHealth: 1700,
        damage: 200,
        ultRequired: 7,
        reloadSpeed: 1.5,
        color: "#e74c3c",
        size: 30,
        speed: 5,
        bulletSpeed: 25,
        bulletSize: 6,
        bulletRange: 1200,
        stunDuration: 5000
      },
      {
        id: 8,
        name: "Biyot",
        health: 800,
        maxHealth: 800,
        damage: 500,
        ultRequired: 5,
        reloadSpeed: 1.8,
        color: "#9b59b6",
        size: 30,
        speed: 7.5,
        bulletSpeed: 45,
        bulletSize: 10,
        bulletRange: 900,
        ultDuration: 5000,
        originalSpeed: 7.5,
        originalDamage: 500,
        originalReloadSpeed: 1.8,
        isUltActive: false,
        phasing: false
      }
    ];

    // Oyun Durumu
    const game = {
      canvas: null,
      ctx: null,
      players: [],
      bullets: [],
      slashes: [], // Asım'ın bıçak saldırıları
      lastTime: 0,
      gameActive: false,
      controls: {
        p1: { up: false, down: false, left: false, right: false, fire: false },
        p2: { up: false, down: false, left: false, right: false, fire: false }
      },
      mobile: {
        moveActive1: false,
        moveActive2: false,
        moveStart1: { x: 0, y: 0 },
        moveStart2: { x: 0, y: 0 },
        moveAngle1: 0,
        moveAngle2: 0,
        lastTap1: 0,
        lastTap2: 0
      }
    };

    // TCX Gölge Efektleri
    function drawPlayerShadow(player) {
      if (!tcxEnabled) return;
      
      // Işık kaynaklarını bul
      const lightBlocks = blocks.filter(block => block.type === "LIGHT");
      
      // En yakın ışığı bul
      let closestLight = null;
      let minDist = Infinity;
      
      for (const light of lightBlocks) {
        const dx = player.x - light.x;
        const dy = player.y - light.y;
        const dist = Math.sqrt(dx*dx + dy*dy);
        if (dist < 300 && dist < minDist) {
          minDist = dist;
          closestLight = light;
        }
      }
      
      // Gölge çiz
      if (closestLight) {
        const light = closestLight;
        const dx = player.x - light.x;
        const dy = player.y - light.y;
        const angle = Math.atan2(dy, dx);
        const shadowLength = 50;
        const shadowX = player.x + Math.cos(angle) * shadowLength;
        const shadowY = player.y + Math.sin(angle) * shadowLength;
        
        game.ctx.fillStyle = 'rgba(0, 0, 0, 0.35)';
        game.ctx.beginPath();
        game.ctx.moveTo(player.x - player.size, player.y - player.size);
        game.ctx.lineTo(shadowX - player.size, shadowY - player.size);
        game.ctx.lineTo(shadowX + player.size, shadowY + player.size);
        game.ctx.lineTo(player.x + player.size, player.y + player.size);
        game.ctx.closePath();
        game.ctx.fill();
      } else {
        // Güneş ışığı için gölge (ekranın sol üst köşesi)
        const sunX = 0;
        const sunY = 0;
        const dx = player.x - sunX;
        const dy = player.y - sunY;
        const dist = Math.sqrt(dx*dx + dy*dy);
        
        if (dist < 500) {
          const angle = Math.atan2(dy, dx);
          const shadowX = player.x + Math.cos(angle) * 70;
          const shadowY = player.y + Math.sin(angle) * 70;
          
          game.ctx.fillStyle = "rgba(0, 0, 0, 0.25)";
          game.ctx.beginPath();
          game.ctx.moveTo(player.x - player.size, player.y - player.size);
          game.ctx.lineTo(shadowX - player.size, shadowY - player.size);
          game.ctx.lineTo(shadowX + player.size, shadowY + player.size);
          game.ctx.lineTo(player.x + player.size, player.y + player.size);
          game.ctx.closePath();
          game.ctx.fill();
        }
      }
    }

    // FPS hesaplama fonksiyonu
    function updateFPS(timestamp) {
      frameCount++;
      
      if (timestamp - lastFpsUpdate >= 1000) {
        fps = frameCount;
        frameCount = 0;
        lastFpsUpdate = timestamp;
        
        // FPS değerini ekranda güncelle
        document.getElementById('fpsCounter').textContent = `FPS: ${fps}`;
      }
      
      // FPS testi aktifse frame sayısını artır
      if (fpsTestActive) {
        fpsTestFrames++;
      }
    }

    // FPS testı başlat
    function startFPSTest() {
      fpsTestActive = true;
      fpsTestStart = performance.now();
      fpsTestFrames = 0;
      fpsTestResults = [];
      document.getElementById('testIndicator').style.display = 'block';
      document.body.classList.add('fps-test-active');
      
      // Test süresince ağır işlemler ekle
      simulateHeavyLoad();
      
      // Test süresini ayarla
      setTimeout(endFPSTest, 5000);
    }

    // Ağır işlem simülasyonu
    function simulateHeavyLoad() {
      if (!fpsTestActive) return;
      
      // Yoğun hesaplamalar ekle
      for (let i = 0; i < 10000; i++) {
        Math.sqrt(Math.random() * 10000);
      }
      
      // Ek nesneler oluştur
      if (game.gameActive) {
        for (let i = 0; i < 20; i++) {
          const angle = Math.random() * Math.PI * 2;
          game.bullets.push({
            id: Date.now() + i,
            x: Math.random() * config.width,
            y: Math.random() * config.height,
            dx: Math.cos(angle) * 10,
            dy: Math.sin(angle) * 10,
            player: Math.floor(Math.random() * 2),
            damage: 50,
            size: 5,
            maxDistance: 500,
            distance: 0,
            angle: angle
          });
        }
      }
      
      // Sürekli olarak test et
      setTimeout(simulateHeavyLoad, 100);
    }

    // FPS testı bitir
    function endFPSTest() {
      fpsTestActive = false;
      const testDuration = 5; // 5 saniye
      const averageFPS = Math.round(fpsTestFrames / testDuration);
      
      // Sonuçları göster
      document.getElementById('fpsValue').textContent = `Ortalama FPS: ${averageFPS}`;
      
      // Kategori belirle
      let category = "";
      let categoryClass = "";
      if (averageFPS < 10) {
        category = "Oyunu Sil! (5-10 FPS)";
        categoryClass = "fps-bad";
      } else if (averageFPS < 20) {
        category = "Kötü (10-20 FPS)";
        categoryClass = "fps-bad";
      } else if (averageFPS < 30) {
        category = "Oynanır (20-30 FPS)";
        categoryClass = "fps-ok";
      } else if (averageFPS < 60) {
        category = "Süper (30-60 FPS)";
        categoryClass = "fps-good";
      } else {
        category = "Süper Cihaz! (60+ FPS)";
        categoryClass = "fps-excellent";
      }
      
      const categoryElement = document.getElementById('fpsCategory');
      categoryElement.textContent = category;
      categoryElement.className = `fps-category ${categoryClass}`;
      
      document.getElementById('fpsTestResult').style.display = 'block';
      document.getElementById('testIndicator').style.display = 'none';
      document.body.classList.remove('fps-test-active');
    }

    // Oyunu Başlat
    function init() {
      // Cihaz tespiti yap
      detectDevice();
      
      // Blokları başlat
      blocks = [
        { type: "STONE", x: 300, y: 300 },
        { type: "STONE", x: 500, y: 700 },
        { type: "GLASS", x: 800, y: 400, health: 3 },
        { type: "GLASS", x: 840, y: 400, health: 3 },
        { type: "WATER", x: 1000, y: 600 },
        { type: "WATER", x: 1040, y: 600 },
        { type: "BOX", x: 1200, y: 300, health: 3 }, // Yeni kutu
        { type: "BOX", x: 1500, y: 500, health: 3 }, // Yeni kutu
        { type: "BOX", x: 1800, y: 700, health: 3 }  // Yeni kutu
      ];
      
      // Yüzen nesneleri oluştur
      createFloatingObjects();
      
      game.canvas = document.getElementById('gameCanvas');
      game.ctx = game.canvas.getContext('2d');
      
      // Boyut ayarlama
      resizeCanvas();
      window.addEventListener('resize', resizeCanvas);
      
      // Kontrolleri ayarla
      setupControls();
      
      // Karakter seçim ekranını oluştur
      renderCharacterSelection();
      
      // Karakter bilgi ekranını oluştur
      renderCharactersScreen();
      
      // Oyun döngüsünü başlat
      gameLoop();
      
      // Ana menüyü göster
      document.getElementById('mainMenu').style.display = 'flex';
      
      // Envanteri başlat
      renderInventory();
      
      // UI ölçeklendirme
      scaleUI();
    }

    // Ekran boyutunu ayarla
    function resizeCanvas() {
      const ratio = Math.min(
        window.innerWidth / config.width,
        window.innerHeight / config.height
      );
      game.canvas.style.width = `${config.width * ratio}px`;
      game.canvas.style.height = `${config.height * ratio}px`;
      
      // Mobil cihazlar için UI ölçeklendirme
      if (deviceType !== 'desktop') {
        scaleUI();
      }
    }

    // Karakter seçim ekranını oluştur
    function renderCharacterSelection() {
      const p1Select = document.getElementById('p1-select');
      const p2Select = document.getElementById('p2-select');
      
      p1Select.innerHTML = '';
      p2Select.innerHTML = '';
      
      characters.forEach(char => {
        const charElement = document.createElement('div');
        charElement.className = 'character';
        charElement.innerHTML = `
          <div class="select-avatar ${char.name.replace(/\s+/g, '')}" style="background-color:${char.color}"></div>
          <h3>${char.name}</h3>
          <div class="character-stats">
            <p>❤️ ${char.health} Can</p>
            <p>🔫 ${char.damage} Hasar</p>
            <p>⚡ ${char.ultRequired} Vuruşta Ulti</p>
            <p>🔄 ${char.reloadSpeed}s Dolum</p>
          </div>
        `;
        
        // 1. Oyuncu için karakter seçimi
        const p1Char = charElement.cloneNode(true);
        p1Char.addEventListener('click', () => {
          p1Select.querySelectorAll('.character').forEach(el => el.classList.remove('selected'));
          p1Char.classList.add('selected');
          game.players[0] = { ...char, selected: true };
          checkStartButton();
        });
        
        // Mobil cihazlar için touch event ekle
        p1Char.addEventListener('touchstart', (e) => {
          e.preventDefault();
          p1Select.querySelectorAll('.character').forEach(el => el.classList.remove('selected'));
          p1Char.classList.add('selected');
          game.players[0] = { ...char, selected: true };
          checkStartButton();
        }, { passive: false });
        
        p1Select.appendChild(p1Char);
        
        // 2. Oyuncu için karakter seçimi
        const p2Char = charElement.cloneNode(true);
        p2Char.addEventListener('click', () => {
          p2Select.querySelectorAll('.character').forEach(el => el.classList.remove('selected'));
          p2Char.classList.add('selected');
          game.players[1] = { ...char, selected: true };
          checkStartButton();
        });
        
        // Mobil cihazlar için touch event ekle
        p2Char.addEventListener('touchstart', (e) => {
          e.preventDefault();
          p2Select.querySelectorAll('.character').forEach(el => el.classList.remove('selected'));
          p2Char.classList.add('selected');
          game.players[1] = { ...char, selected: true };
          checkStartButton();
        }, { passive: false });
        
        p2Select.appendChild(p2Char);
      });
    }

    // Başlat butonunu kontrol et
    function checkStartButton() {
      document.getElementById('startButton').disabled = !(game.players[0]?.selected && game.players[1]?.selected);
    }

    // Oyunu başlat
    function startGame() {
      // Seçim ekranını gizle
      document.getElementById('selectScreen').style.display = 'none';
      
      // Işık bloklarını rastgele oluştur
      blocks = blocks.filter(block => !BLOCK_TYPES[block.type].lightSource);
      for (let i = 0; i < 5; i++) {
        blocks.push({
          type: "LIGHT",
          x: Math.floor(Math.random() * (config.width - BLOCK_SIZE)),
          y: Math.floor(Math.random() * (config.height - BLOCK_SIZE))
        });
      }
      
      // Oyuncuları başlat
      game.players = game.players.map((player, index) => {
        return {
          ...player,
          x: index === 0 ? 400 : 2000,
          y: config.height / 2,
          ammo: config.maxAmmo,
          ultCharge: 0,
          lastShot: 0,
          lastReloadTime: 0,
          lastHit: 0,
          health: player.maxHealth,
          infoElement: createPlayerInfoElement(index),
          bulletsFired: 0,
          noDamageTime: 0,
          lastRegen: 0,
          regenAmount: 50,
          regenActive: false,
          originalDamage: player.damage,
          originalSpeed: player.speed,
          originalReloadSpeed: player.reloadSpeed,
          originalBulletSize: player.bulletSize,
          ultActive: false,
          originalHealth: player.maxHealth,
          originalColor: player.color,
          // Asım/Burak için özel özellikler
          currentMode: player.name === "Asım/Burak" ? 1 : 0,
          modeSwitchTime: 0,
          lastHealTime: 0,
          slowed: false,
          slowEndTime: 0,
          poisonEndTime: 0,
          lastPoisonTick: 0,
          // Yeni: Son ateş yönü
          lastFireDirection: index === 0 ? 0 : Math.PI // 1. oyuncu sağa, 2. oyuncu sola
        };
      });
      
      // Mobil kontrolleri göster
      if (deviceType !== 'desktop') {
        document.querySelector('.mobile-controls').style.display = 'flex';
        document.querySelectorAll('.ulti-btn').forEach(btn => {
          btn.style.display = 'flex';
        });
        document.querySelectorAll('.fire-btn').forEach(btn => {
          btn.style.display = 'flex';
        });
      }
      
      game.gameActive = true;
      game.lastTime = performance.now();
    }

    // Oyuncu bilgi elementi oluştur
    function createPlayerInfoElement(index) {
      const element = document.createElement('div');
      element.className = 'player-info';
      element.id = `player${index+1}-info`;
      document.getElementById('gameUI').appendChild(element);
      return element;
    }

    // Kontrolleri ayarla
    function setupControls() {
      // Klavye kontrolleri
      window.addEventListener('keydown', handleKeyDown);
      window.addEventListener('keyup', handleKeyUp);
      
      // Mobil kontroller
      if (deviceType !== 'desktop') {
        setupMobileControls();
      }
      
      // Oyun butonları - Mobil uyumlu hale getirildi
      const addMobileEvent = (element, eventName, handler) => {
        element.addEventListener(eventName, handler);
        if (eventName === 'click') {
          element.addEventListener('touchstart', function(e) {
            e.preventDefault();
            handler.call(this, e);
          }, { passive: false });
        }
      };
      
      // Ana menü butonları için event listener'ları düzelt
      addMobileEvent(document.getElementById('playButton'), 'click', () => {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('selectScreen').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('charactersButton'), 'click', () => {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('charactersScreen').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('inventoryButton'), 'click', () => {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('inventoryScreen').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('settingsButton'), 'click', () => {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('settingsScreen').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('marketButton'), 'click', () => {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('marketScreen').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('closeSettingsBtn'), 'click', () => {
        document.getElementById('settingsScreen').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('closeCharactersBtn'), 'click', () => {
        document.getElementById('charactersScreen').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('closeInventoryBtn'), 'click', () => {
        document.getElementById('inventoryScreen').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('closeMarketBtn'), 'click', () => {
        document.getElementById('marketScreen').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('startButton'), 'click', startGame);
      addMobileEvent(document.getElementById('restartButton'), 'click', restartGame);
      
      // Ulti butonları için özel touch event
      document.getElementById('ultiBtn1').addEventListener('touchstart', (e) => {
        e.preventDefault();
        useUltimate(0);
      }, { passive: false });
      
      document.getElementById('ultiBtn2').addEventListener('touchstart', (e) => {
        e.preventDefault();
        useUltimate(1);
      }, { passive: false });
      
      // Ateş butonları için özel touch event
      document.getElementById('fireBtn1').addEventListener('touchstart', (e) => {
        e.preventDefault();
        shoot(0);
      }, { passive: false });
      
      document.getElementById('fireBtn2').addEventListener('touchstart', (e) => {
        e.preventDefault();
        shoot(1);
      }, { passive: false });
      
      // FPS test butonu
      addMobileEvent(document.getElementById('runFPSTest'), 'click', startFPSTest);
      
      // FPS test sonuçlarını kapat
      addMobileEvent(document.querySelector('.close-test-btn'), 'click', () => {
        document.getElementById('fpsTestResult').style.display = 'none';
      });
      
      // TCX butonu
      addMobileEvent(document.getElementById('toggleTCX'), 'click', function () {
        tcxEnabled = !tcxEnabled;
        this.textContent = "TCX: " + (tcxEnabled ? "AÇIK" : "KAPALI");
        this.style.background = tcxEnabled ? "green" : "red";
        glCanvas.style.display = tcxEnabled ? "block" : "none";
        
        if (tcxEnabled && !shaderInitialized) {
          //initTCXShaders();
          shaderInitialized = true;
          
          // Işık efektini güçlendir
          document.body.style.background = "radial-gradient(circle at center, #2c3e50, #1a1a2e)";
        } else {
          // Orijinal arkaplan
          document.body.style.background = "#111";
        }
      });
      
      // Envanter butonları
      addMobileEvent(document.getElementById('inventoryButton'), 'click', () => {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('inventoryScreen').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('closeInventoryBtn'), 'click', () => {
        document.getElementById('inventoryScreen').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'flex';
      });
      
      // Market butonları
      addMobileEvent(document.getElementById('marketButton'), 'click', () => {
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('marketScreen').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('closeMarketBtn'), 'click', () => {
        document.getElementById('marketScreen').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'flex';
      });
      
      addMobileEvent(document.getElementById('freeBoxButton'), 'click', () => {
        const randomId = Math.floor(Math.random() * 2) + 1; // 1 veya 2
        addToInventory(randomId);
        const sticker = stickers.find(s => s.id === randomId);
        document.getElementById('boxResult').textContent = `${sticker.name} kazandınız!`;
      });
    }

    // Klavye girişi
    function handleKeyDown(event) {
      // 1. Oyuncu kontrolleri (WASD + X ulti)
      if (event.key === 'w') game.controls.p1.up = true;
      if (event.key === 's') game.controls.p1.down = true;
      if (event.key === 'a') game.controls.p1.left = true;
      if (event.key === 'd') game.controls.p1.right = true;
      if (event.key === ' ') useUltimate(0);
      if (event.key === 'h' || event.key === 'H') shoot(0);
      
      // 2. Oyuncu kontrolleri (Yön tuşları + Enter ulti)
      if (event.key === 'ArrowUp') game.controls.p2.up = true;
      if (event.key === 'ArrowDown') game.controls.p2.down = true;
      if (event.key === 'ArrowLeft') game.controls.p2.left = true;
      if (event.key === 'ArrowRight') game.controls.p2.right = true;
      if (event.key === 'Enter') useUltimate(1);
      if (event.key === '.' || event.key === '>') shoot(1);
    }

    function handleKeyUp(event) {
      // 1. Oyuncu kontrolleri
      if (event.key === 'w') game.controls.p1.up = false;
      if (event.key === 's') game.controls.p1.down = false;
      if (event.key === 'a') game.controls.p1.left = false;
      if (event.key === 'd') game.controls.p1.right = false;
      
      // 2. Oyuncu kontrolleri
      if (event.key === 'ArrowUp') game.controls.p2.up = false;
      if (event.key === 'ArrowDown') game.controls.p2.down = false;
      if (event.key === 'ArrowLeft') game.controls.p2.left = false;
      if (event.key === 'ArrowRight') game.controls.p2.right = false;
    }

    // Mobil kontrolleri ayarla
    function setupMobileControls() {
      const moveJoystick1 = document.getElementById('moveJoystick1');
      const moveJoystick2 = document.getElementById('moveJoystick2');
      
      // 1. Oyuncu joystick
      moveJoystick1.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobile.moveActive1 = true;
        const rect = moveJoystick1.getBoundingClientRect();
        game.mobile.moveStart1 = {
          x: rect.left + rect.width / 2,
          y: rect.top + rect.height / 2
        };
        updateJoystick(e.touches[0], 'move1');
      }, { passive: false });
      
      // 2. Oyuncu joystick
      moveJoystick2.addEventListener('touchstart', (e) => {
        e.preventDefault();
        game.mobile.moveActive2 = true;
        const rect = moveJoystick2.getBoundingClientRect();
        game.mobile.moveStart2 = {
          x: rect.left + rect.width / 2,
          y: rect.top + rect.height / 2
        };
        updateJoystick(e.touches[0], 'move2');
      }, { passive: false });
      
      // Dokunmatik hareket
      document.addEventListener('touchmove', (e) => {
        e.preventDefault();
        if (game.mobile.moveActive1) updateJoystick(e.touches[0], 'move1');
        if (game.mobile.moveActive2) updateJoystick(e.touches[0], 'move2');
      }, { passive: false });
      
      // Dokunmatik bırakma
      document.addEventListener('touchend', (e) => {
        if (game.mobile.moveActive1) {
          game.mobile.moveActive1 = false;
          document.querySelector('#moveJoystick1 .joystick-thumb').style.transform = 'translate(0, 0)';
          // Hareketi durdur
          game.controls.p1.up = false;
          game.controls.p1.down = false;
          game.controls.p1.left = false;
          game.controls.p1.right = false;
        }
        if (game.mobile.moveActive2) {
          game.mobile.moveActive2 = false;
          document.querySelector('#moveJoystick2 .joystick-thumb').style.transform = 'translate(0, 0)';
          // Hareketi durdur
          game.controls.p2.up = false;
          game.controls.p2.down = false;
          game.controls.p2.left = false;
          game.controls.p2.right = false;
        }
      });
    }

    // Joystick pozisyonunu güncelle
    function updateJoystick(touch, type) {
      const playerIndex = type === 'move1' ? 0 : 1;
      const joystick = document.querySelector(`#moveJoystick${playerIndex + 1} .joystick-thumb`);
      const start = type === 'move1' ? game.mobile.moveStart1 : game.mobile.moveStart2;
      
      const dx = touch.clientX - start.x;
      const dy = touch.clientY - start.y;
      const distance = Math.min(Math.sqrt(dx * dx + dy * dy), 50);
      const angle = Math.atan2(dy, dx);
      
      joystick.style.transform = `translate(${distance * Math.cos(angle)}px, ${distance * Math.sin(angle)}px)`;
      
      if (type === 'move1') {
        game.mobile.moveAngle1 = angle;
        game.controls.p1.up = dy < -10;
        game.controls.p1.down = dy > 10;
        game.controls.p1.left = dx < -10;
        game.controls.p1.right = dx > 10;
      } else {
        game.mobile.moveAngle2 = angle;
        game.controls.p2.up = dy < -10;
        game.controls.p2.down = dy > 10;
        game.controls.p2.left = dx < -10;
        game.controls.p2.right = dx > 10;
      }
    }

    // Ateş etme
    function shoot(playerIndex) {
      const player = game.players[playerIndex];
      if (!player) return;
      
      // Asım/Burak karakteri için özel ateş etme mantığı
      if (player.name === "Asım/Burak") {
        if (player.currentMode === 1) { // Asım modu
          // Mermi kontrolü eklendi
          if (player.ammo <= 0) return;
          
          const now = performance.now();
          
          // Saldırı bekleme süresi
          if (now - player.lastShot < 500) return;
          player.lastShot = now;
          
          // Mermi tüketimi eklendi
          player.ammo--;
          
          // Ateş yönünü belirle
          let angle = determineFireDirection(playerIndex);
          
          // Son ateş yönünü kaydet
          player.lastFireDirection = angle;
          
          // Bıçak saldırısı oluştur
          const slash = {
            id: Date.now(),
            x: player.x,
            y: player.y,
            angle: angle,
            player: playerIndex,
            damage: player.damage,
            size: 40,
            range: 80,
            created: now
          };
          
          game.slashes.push(slash);
        }
        return;
      }
      
      // Diğer karakterler için normal ateş etme
      // Mermi kontrolü düzeltildi
      if (!player || player.ammo <= 0) return;
      
      const now = Date.now();
      
      // Mermi ve bekleme kontrolü
      if (now - player.lastShot < 300) return;
      
      player.ammo--;
      player.lastShot = now;
      
      // Ateş yönünü belirle
      let angle = determineFireDirection(playerIndex);
      
      // Son ateş yönünü kaydet
      player.lastFireDirection = angle;
      
      if (player.name === "Halk") {
        const angles = [
          angle,
          angle + 0.7854,
          angle - 0.7854
        ];
        const damages = [400, 200, 200];
        angles.forEach((a, i) => {
          const bulletId = player.bulletsFired++;
          game.bullets.push({
            id: bulletId,
            x: player.x,
            y: player.y,
            dx: Math.cos(a) * player.bulletSpeed,
            dy: Math.sin(a) * player.bulletSpeed,
            player: playerIndex,
            damage: damages[i],
            size: player.bulletSize,
            maxDistance: player.bulletRange,
            distance: 0,
            angle: a,
            isHoming: true,
            homingOffset: Math.random() * 0.08 - 0.04,
            speed: player.bulletSpeed
          });
        });
        return;
      }
      // Ulti aktifse mermi boyutunu 10 katına çıkar
      const bulletSize = player.ultActive ? player.originalBulletSize * 10 : player.bulletSize;
      
      // Mermi oluştur
      const bulletId = player.bulletsFired++;
      game.bullets.push({
        id: bulletId,
        x: player.x,
        y: player.y,
        dx: Math.cos(angle) * player.bulletSpeed,
        dy: Math.sin(angle) * player.bulletSpeed,
        player: playerIndex,
        damage: player.damage,
        size: bulletSize,
        maxDistance: player.bulletRange,
        distance: 0,
        angle: angle
      });
    }

    // Ateş yönünü belirleme
    function determineFireDirection(playerIndex) {
      const player = game.players[playerIndex];
      let angle;
      
      if (deviceType !== 'desktop') {
        // Mobil cihazlar için joystick açısını kullan
        if (playerIndex === 0 && game.mobile.moveActive1) {
          angle = game.mobile.moveAngle1;
        } else if (playerIndex === 1 && game.mobile.moveActive2) {
          angle = game.mobile.moveAngle2;
        } else {
          // Joystick aktif değilse son ateş yönünü kullan
          angle = player.lastFireDirection;
        }
      } else {
        // PC için yön tuşlarını kontrol et
        const controls = game.controls[`p${playerIndex+1}`];
        if (controls.up) angle = -Math.PI/2;
        else if (controls.down) angle = Math.PI/2;
        else if (controls.left) angle = Math.PI;
        else if (controls.right) angle = 0;
        else angle = player.lastFireDirection; // Hiçbir tuş basılı değilse son ateş yönünü kullan
      }
      
      return angle;
    }

    // Ulti kullanma
    function useUltimate(playerIndex) {
      const player = game.players[playerIndex];
      if (!player || player.ultCharge < player.ultRequired) return;
      
      // Asım/Burak karakteri için özel ulti mantığı
      if (player.name === "Asım/Burak") {
        if (player.currentMode === 1) { // Asım -> Burak
          player.ultCharge = 0;
          player.currentMode = 2;
          player.color = player.burakMode.color;
          player.maxHealth = player.burakMode.maxHealth;
          player.speed = player.burakMode.speed;
          player.damage = player.burakMode.damage;
          player.modeSwitchTime = performance.now();
          player.lastHealTime = performance.now();
          
          if (playerIndex === 0) {
            document.getElementById('ultiBtn1').classList.remove('active');
          } else {
            document.getElementById('ultiBtn2').classList.remove('active');
          }
        }
        return;
      }
      
      player.ultCharge = 0;
      if (playerIndex === 0) {
        document.getElementById('ultiBtn1').classList.remove('active');
      } else {
        document.getElementById('ultiBtn2').classList.remove('active');
      }
      if (player.name === "Hett") {
        // Yön kontrollü dash (3 oyuncu boyu mesafe)
        const dashDistance = player.size * 3;
        const controls = game.controls[`p${playerIndex+1}`];
        let dx = 0, dy = 0;
        if (controls.up) dy = -dashDistance;
        if (controls.down) dy = dashDistance;
        if (controls.left) dx = -dashDistance;
        if (controls.right) dx = dashDistance;
        player.x = Math.max(player.size, Math.min(config.width - player.size, player.x + dx));
        player.y = Math.max(player.size, Math.min(config.height - player.size, player.y + dy));
        player.health = Math.min(player.health + 150, player.maxHealth);
        player.ammo = Math.min(player.ammo + 3, config.maxAmmo);
      } else if (player.name === "Pro") {
        const enemyIndex = playerIndex === 0 ? 1 : 0;
        const enemy = game.players[enemyIndex];
        player.x = enemy.x;
        player.y = enemy.y;
        enemy.stunned = performance.now() + player.stunDuration;
        player.health = player.maxHealth;
        player.ammo = config.maxAmmo;
        player.damage = player.originalDamage * 2;
        setTimeout(() => {
          player.damage = player.originalDamage;
        }, player.stunDuration);
      } 
      else if (player.name === "Bıdır") {
        player.specialAbilityActive = true;
        player.speed = player.originalSpeed * 2;
        player.damage = player.originalDamage * 2;
        player.reloadSpeed = player.originalReloadSpeed / 2;
        const ultCircle = {
          x: player.x,
          y: player.y,
          radius: player.ultRadius,
          endTime: performance.now() + player.ultDuration
        };
        game.players.forEach((p, index) => {
          if(index !== playerIndex) {
            const distance = Math.hypot(p.x - ultCircle.x, p.y - ultCircle.y);
            if(distance < ultCircle.radius) {
              p.stunned = ultCircle.endTime;
            }
          }
        });
        setTimeout(() => {
          player.specialAbilityActive = false;
          player.speed = player.originalSpeed;
          player.damage = player.originalDamage;
          player.reloadSpeed = player.originalReloadSpeed;
          game.players.forEach(p => {
            if(p.stunned === ultCircle.endTime) {
              p.stunned = null;
            }
          });
        }, player.ultDuration);
      }
      else if (player.name === "Mısır") {
        player.isUltActive = true;
        setTimeout(() => {
          player.isUltActive = false;
        }, player.ultDuration);
      }
      else {
        player.ultActive = true;
        player.maxHealth = player.originalHealth * 2;
        player.health = player.maxHealth;
        player.damage = player.originalDamage * 2;
        player.speed = player.originalSpeed * 2;
        player.reloadSpeed = player.originalReloadSpeed / 2;
        player.bulletSize = player.originalBulletSize * 10;
        setTimeout(() => {
          player.ultActive = false;
          player.maxHealth = player.originalHealth;
          player.health = Math.min(player.health, player.maxHealth);
          player.damage = player.originalDamage;
          player.speed = player.originalSpeed;
          player.reloadSpeed = player.originalReloadSpeed;
          player.bulletSize = player.originalBulletSize;
        }, player.ultDuration);
      }
    }

    // Blok çizimi
    function drawBlocks(ctx) {
      blocks.forEach(block => {
        const blockType = BLOCK_TYPES[block.type];
        ctx.fillStyle = blockType.color;
        
        // Kırılabilir bloklar için hasar durumu
        if (block.health <= 0 && blockType.breakable) {
          ctx.globalAlpha = 0.3;
        }
        
        ctx.fillRect(block.x, block.y, BLOCK_SIZE, BLOCK_SIZE);
        
        // Kutular için ekstra desen
        if (block.type === "BOX") {
          ctx.fillStyle = "rgba(0, 0, 0, 0.2)";
          ctx.fillRect(block.x + 5, block.y + 5, 10, 10);
          ctx.fillRect(block.x + BLOCK_SIZE - 15, block.y + 5, 10, 10);
          ctx.fillRect(block.x + 5, block.y + BLOCK_SIZE - 15, 10, 10);
          ctx.fillRect(block.x + BLOCK_SIZE - 15, block.y + BLOCK_SIZE - 15, 10, 10);
          ctx.fillRect(block.x + BLOCK_SIZE/2 - 5, block.y + BLOCK_SIZE/2 - 5, 10, 10);
        }
        
        // Işık blokları için ekstra efekt
        if (block.type === "LIGHT") {
          // Işık hüzmesi efekti
          const beam = document.createElement('div');
          beam.className = 'light-beam';
          beam.style.width = '150px';
          beam.style.height = '150px';
          beam.style.left = `${block.x + BLOCK_SIZE/2 - 75}px`;
          beam.style.top = `${block.y + BLOCK_SIZE/2 - 75}px`;
          document.body.appendChild(beam);
          setTimeout(() => {
            beam.remove();
          }, 100);
        }
        
        ctx.globalAlpha = 1.0;
      });
    }

    // Blok çarpışma kontrolü
    function checkBlockCollision(x, y, size) {
      for (const block of blocks) {
        const blockType = BLOCK_TYPES[block.type];
        
        // Kırılmış cam veya ışık bloklarından geçilebilir
        if ((blockType.breakable && block.health <= 0) || blockType.lightSource) {
          continue;
        }
        
        const blockLeft = block.x;
        const blockRight = block.x + BLOCK_SIZE;
        const blockTop = block.y;
        const blockBottom = block.y + BLOCK_SIZE;
        
        // Çarpışma kontrolü
        if (x + size > blockLeft && x - size < blockRight &&
            y + size > blockTop && y - size < blockBottom) {
          return true;
        }
      }
      return false;
    }

    // Oyuncu ve blok çarpışması
    function resolvePlayerBlockCollision(player) {
      const size = player.size;
      let newX = player.x;
      let newY = player.y;
      
      // Yeni pozisyonı kontrol et
      if (checkBlockCollision(newX, newY, size)) {
        // Sola hareket
        if (game.controls[`p${player === game.players[0] ? 1 : 2}`].left) {
          newX = player.x + player.speed;
        }
        // Sağa hareket
        if (game.controls[`p${player === game.players[0] ? 1 : 2}`].right) {
          newX = player.x - player.speed;
        }
        // Yukarı hareket
        if (game.controls[`p${player === game.players[0] ? 1 : 2}`].up) {
          newY = player.y + player.speed;
        }
        // Aşağı hareket
        if (game.controls[`p${player === game.players[0] ? 1 : 2}`].down) {
          newY = player.y - player.speed;
        }
        
        // Yeni pozisyonu ayarla
        player.x = newX;
        player.y = newY;
      }
    }

    // Mermi ve blok çarpışması
    function checkBulletBlockCollision(bullet) {
      for (const block of blocks) {
        const blockType = BLOCK_TYPES[block.type];
        
        // Kırılmış cam veya ışık bloklarından geçebilir
        if ((blockType.breakable && block.health <= 0) || blockType.lightSource) {
          continue;
        }
        
        const blockLeft = block.x;
        const blockRight = block.x + BLOCK_SIZE;
        const blockTop = block.y;
        const blockBottom = block.y + BLOCK_SIZE;
        
        // Çarpışma kontrolü
        if (bullet.x > blockLeft && bullet.x < blockRight &&
            bullet.y > blockTop && bullet.y < blockBottom) {
          
          // Cam ve kutu bloklara hasar ver
          if (blockType.breakable) {
            block.health--;
            
            // Kutu kırılırsa
            if (block.type === "BOX" && block.health <= 0) {
              // Kırılma efekti
              const effect = document.createElement('div');
              effect.className = 'box-break-effect';
              effect.style.left = `${block.x + BLOCK_SIZE/2 - 40}px`;
              effect.style.top = `${block.y + BLOCK_SIZE/2 - 40}px`;
              document.body.appendChild(effect);
              setTimeout(() => {
                effect.remove();
              }, 500);
              
              // Rastgele çıkartma ekle
              const stickerId = Math.floor(Math.random() * 2) + 1; // 1 veya 2
              addToInventory(stickerId);
            }
          }
          
          return true;
        }
      }
      return false;
    }

    // Renk interpolasyonu
    function interpolateColor(color1, color2, factor) {
      const r1 = parseInt(color1.substring(1, 3), 16);
      const g1 = parseInt(color1.substring(3, 5), 16);
      const b1 = parseInt(color1.substring(5, 7), 16);
      
      const r2 = parseInt(color2.substring(1, 3), 16);
      const g2 = parseInt(color2.substring(3, 5), 16);
      const b2 = parseInt(color2.substring(5, 7), 16);
      
      const r = Math.round(r1 + (r2 - r1) * factor);
      const g = Math.round(g1 + (g2 - g1) * factor);
      const b = Math.round(b1 + (b2 - b1) * factor);
      
      return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
    }

    // Oyun döngüsü
    function gameLoop(timestamp) {
      // FPS güncelleme
      updateFPS(timestamp);
      
      // Ekranı temizle
      game.ctx.clearRect(0, 0, config.width, config.height);
      
      drawBackground(game.ctx, config.width, config.height);
      
      // Blokları çiz
      drawBlocks(game.ctx);
      
      // Oyun aktifse güncelle ve çiz
      if (game.gameActive) {
        updateGame(timestamp);
        renderGame();
      }
      
      // Döngüyü sürdür
      requestAnimationFrame(gameLoop);
    }

    // Oyun durumunu güncelle
    function updateGame(timestamp) {
      const deltaTime = timestamp - game.lastTime;
      game.lastTime = timestamp;
      
      // Mısır aura etkisi
      const misir = game.players.find(p => p?.name === "Mısır");
      if (misir) {
        const radius = misir.isUltActive ? misir.ultRadius : misir.auraRadius;
        
        // Oyuncular üzerinde yavaşlatma etkisi
        game.players.forEach((enemy, index) => {
          if (enemy !== misir && enemy.originalSpeed !== undefined) {
            const distance = Math.hypot(enemy.x - misir.x, enemy.y - misir.y);
            if (distance < radius) {
              enemy.speed = enemy.originalSpeed * 0.25;
            } else {
              enemy.speed = enemy.originalSpeed;
            }
          }
        });
        
        // Mermiler üzerinde yavaşlatma etkisi
        game.bullets.forEach(bullet => {
          const shooter = game.players[bullet.player];
          if (!shooter || shooter === misir) return;
          
          const distance = Math.hypot(shooter.x - misir.x, shooter.y - misir.y);
          
          if (bullet.originalDx === undefined) {
            bullet.originalDx = bullet.dx;
            bullet.originalDy = bullet.dy;
          }
          
          if (distance < radius) {
            bullet.dx = bullet.originalDx * 0.25;
            bullet.dy = bullet.originalDy * 0.25;
          } else {
            bullet.dx = bullet.originalDx;
            bullet.dy = bullet.originalDy;
          }
        });
      }
      
      // Halk mermilerı hedef takibi yapar
      game.bullets.forEach(bullet => {
        if(bullet.isHoming) {
          const enemyIndex = bullet.player === 0 ? 1 : 0;
          const enemy = game.players[enemyIndex];
          
          if(enemy && !enemy.stunned) {
            const targetAngle = Math.atan2(
              enemy.y - bullet.y + bullet.homingOffset * 50,
              enemy.x - bullet.x + bullet.homingOffset * 50
            );
            
            bullet.angle += (targetAngle - bullet.angle) * 0.08;
            bullet.dx = Math.cos(bullet.angle) * bullet.speed;
            bullet.dy = Math.sin(bullet.angle) * bullet.speed;
          }
        }
      });
      
      // Oyuncuları güncelle
      game.players.forEach((player, index) => {
        if (!player) return;
        
        // Blok çarpışma kontrolü
        resolvePlayerBlockCollision(player);
        
        // Felç kontrolü
        if (player.stunned && timestamp < player.stunned) {
          return; // Felçli oyuncu hareket edemez
        } else if (player.stunned) {
          player.stunned = null; // Felç süresi doldu
        }
        
        // Yavaşlatma kontrolü
        if (player.slowed && timestamp < player.slowEndTime) {
          player.speed = player.originalSpeed * 0.5;
        } else if (player.slowed) {
          player.slowed = false;
          player.speed = player.originalSpeed;
        }
        
        // Zehir hasarı kontrolü
        if (player.poisonEndTime && timestamp < player.poisonEndTime) {
          if (timestamp - player.lastPoisonTick > 1000) {
            player.health -= 50;
            player.lastPoisonTick = timestamp;
          }
        } else if (player.poisonEndTime) {
          player.poisonEndTime = 0;
        }
        
        const controls = game.controls[`p${index+1}`];
        const speed = player.speed * (deltaTime / 16);
        
        // Oyuncu hareketı
        let newX = player.x;
        let newY = player.y;
        
        if (controls.up) newY -= speed;
        if (controls.down) newY += speed;
        if (controls.left) newX -= speed;
        if (controls.right) newX += speed;
        
        // Sınır kontrolleri
        newX = Math.max(player.size, Math.min(config.width - player.size, newX));
        newY = Math.max(player.size, Math.min(config.height - player.size, newY));
        
        // Blok çarpışma kontrolü
        if (!checkBlockCollision(newX, newY, player.size)) {
          player.x = newX;
          player.y = newY;
        }
        
        // Asım/Burak karakteri için özel güncelleme
        if (player.name === "Asım/Burak") {
          // Oyuncu ışık yoğunluğunu güncelle (TCX için)
          playerLightData[index] = player.currentMode === 1 ? 1.2 : 0.7;
          
          if (player.currentMode === 2) { // Burak modu
            // Can yenileme (saniyede 50)
            if (timestamp - player.lastHealTime > 1000) {
              player.health = Math.min(player.health + 50, player.maxHealth);
              player.lastHealTime = timestamp;
            }
            
            // 15 saniye dolunca Asım'a dön
            if (timestamp - player.modeSwitchTime > player.ultDuration) {
              player.currentMode = 1;
              player.color = player.asimMode.color;
              player.maxHealth = player.asimMode.maxHealth;
              player.speed = player.asimMode.speed;
              player.damage = player.asimMode.damage;
              player.ultCharge = 0;
              if (index === 0) {
                document.getElementById('ultiBtn1').classList.remove('active');
              } else {
                document.getElementById('ultiBtn2').classList.remove('active');
              }
            }
          }
        } else {
          // Diğer karakterler için normal ışık yoğunluğu
          playerLightData[index] = player.ultActive ? 1.5 : 0.8;
        }
        
        // Mermi dolumu (1 saniyede 1 mermi - Asım için)
        if (player.ammo < config.maxAmmo && timestamp - player.lastReloadTime > player.reloadSpeed * 1000) {
          player.ammo = Math.min(player.ammo + 1, config.maxAmmo);
          player.lastReloadTime = timestamp;
        }
        
        // Can yenileme sistemi
        if (timestamp - player.lastHit > config.healthRegenDelay) {
          if (!player.regenActive) {
            player.regenActive = true;
            player.lastRegen = timestamp;
            player.regenAmount = 50;
          }
          
          if (timestamp - player.lastRegen > config.healthRegenInterval) {
            player.health = Math.min(player.health + player.regenAmount, player.maxHealth);
            player.lastRegen = timestamp;
          }
        } else {
          player.regenActive = false;
        }
        
        // Ulti butonunu güncelle
        if (index === 0) {
          if (player.ultCharge >= player.ultRequired) {
            document.getElementById('ultiBtn1').classList.add('active');
          } else {
            document.getElementById('ultiBtn1').classList.remove('active');
          }
        } else {
          if (player.ultCharge >= player.ultRequired) {
            document.getElementById('ultiBtn2').classList.add('active');
          } else {
            document.getElementById('ultiBtn2').classList.remove('active');
          }
        }
        
        // Bilgi elementini güncelle
        if (player.infoElement) {
          const ratio = Math.min(
            window.innerWidth / config.width,
            window.innerHeight / config.height
          );
          const x = player.x * ratio;
          const y = (player.y - player.size - 15) * ratio; // 15px yukarıda
          
          player.infoElement.style.left = `${x}px`;
          player.infoElement.style.top = `${y}px`;
          player.infoElement.textContent = `${player.name}: ❤️${Math.round(player.health)} | 🔫${player.ammo}/${config.maxAmmo} | ⚡${player.ultCharge}/${player.ultRequired}`;
          
          // Asım/Burak için mod bilgisi
          if (player.name === "Asım/Burak") {
            player.infoElement.textContent += ` | ${player.currentMode === 1 ? "ASIM" : "BURAK"}`;
          }
        }
      });
      
      // Mermileri güncelle
      game.bullets = game.bullets.filter(bullet => {
        // Mermiyi hareket ettir
        bullet.x += bullet.dx;
        bullet.y += bullet.dy;
        bullet.distance += Math.sqrt(bullet.dx * bullet.dx + bullet.dy * bullet.dy);
        
        // Blok çarpışma kontrolü
        if (checkBulletBlockCollision(bullet)) {
          return false;
        }
        
        // Menzil kontrolü
        if (bullet.distance > bullet.maxDistance) {
          return false;
        }
        
        // Sınır kontrolü
        if (bullet.x < 0 || bullet.x > config.width || 
            bullet.y < 0 || bullet.y > config.height) {
          return false;
        }
        
        // Çarpışma kontrolü
        const enemyIndex = bullet.player === 0 ? 1 : 0;
        const enemy = game.players[enemyIndex];
        if (!enemy) return true;
        
        const distance = Math.sqrt(
          Math.pow(bullet.x - enemy.x, 2) + 
          Math.pow(bullet.y - enemy.y, 2)
        );
        
        if (distance < enemy.size) {
          // Hasar ver
          enemy.health -= bullet.damage;
          enemy.wasHit = true;
          enemy.lastHit = timestamp;
          
          // Ulti şarjı
          const shooter = game.players[bullet.player];
          shooter.ultCharge++;
          
          // Ulti butonunu güncelle
          if (bullet.player === 0 && shooter.ultCharge >= shooter.ultRequired) {
            document.getElementById('ultiBtn1').classList.add('active');
          } else if (bullet.player === 1 && shooter.ultCharge >= shooter.ultRequired) {
            document.getElementById('ultiBtn2').classList.add('active');
          }
          
          return false;
        }
        
        return true;
      });
      
      // Asım'ın bıçak saldırılarını güncelle
      game.slashes = game.slashes.filter(slash => {
        const player = game.players[slash.player];
        const enemyIndex = slash.player === 0 ? 1 : 0;
        const enemy = game.players[enemyIndex];
        
        // Saldırı pozisyonunu güncelle
        slash.x = player.x + Math.cos(slash.angle) * 50;
        slash.y = player.y + Math.sin(slash.angle) * 50;
        
        // Çarpışma kontrolü
        if (enemy) {
          const distance = Math.sqrt(
            Math.pow(slash.x - enemy.x, 2) + 
            Math.pow(slash.y - enemy.y, 2)
          );
          
          if (distance < enemy.size + slash.size/2) {
            // Hasar ver
            enemy.health -= slash.damage;
            enemy.wasHit = true;
            enemy.lastHit = timestamp;
            
            // Yavaşlatma ve zehir efekti
            enemy.slowed = true;
            enemy.slowEndTime = timestamp + 4000;
            enemy.poisonEndTime = timestamp + 4000;
            enemy.lastPoisonTick = timestamp;
            
            // Ulti şarjı
            player.ultCharge++;
            if (slash.player === 0 && player.ultCharge >= player.ultRequired) {
              document.getElementById('ultiBtn1').classList.add('active');
            } else if (slash.player === 1 && player.ultCharge >= player.ultRequired) {
              document.getElementById('ultiBtn2').classList.add('active');
            }
            
            return false;
          }
        }
        
        // Saldırı süresi doldu mu?
        return timestamp - slash.created < 300;
      });
      
      // Ölüm kontrolü
      game.players.forEach((player, index) => {
        if (player && player.health <= 0) {
          endGame(index === 0 ? 1 : 0);
        }
      });
    }

    // Oyunu çiz
    function renderGame() {
      // Mısır aura çemberi çizimi
      game.players.forEach(player => {
        if(player?.name === "Mısır") {
          const radius = player.isUltActive ? player.ultRadius : player.auraRadius;
          game.ctx.beginPath();
          game.ctx.arc(player.x, player.y, radius, 0, Math.PI * 2);
          game.ctx.strokeStyle = player.isUltActive ? "rgba(255,0,0,0.5)" : "rgba(255,215,0,0.3)";
          game.ctx.lineWidth = 8;
          game.ctx.setLineDash([10, 5]);
          game.ctx.stroke();
          game.ctx.setLineDash([]);
        }
      });
      
      // Oyuncular için gölgeleri çiz
      if (tcxEnabled) {
        game.players.forEach(player => {
          if (!player) return;
          drawPlayerShadow(player);
        });
      }
      
      // Oyuncuları çiz
      game.players.forEach(player => {
        if (!player) return;
        
        // Işık bloklarına yakınlığa göre renk değişimi
        let playerColor = player.color;
        if (tcxEnabled) {
          let lightIntensity = 0;
          blocks.forEach(block => {
            if (block.type === "LIGHT") {
              const blockCenterX = block.x + BLOCK_SIZE/2;
              const blockCenterY = block.y + BLOCK_SIZE/2;
              const dx = player.x - blockCenterX;
              const dy = player.y - blockCenterY;
              const dist = Math.sqrt(dx*dx + dy*dy);
              // Işık menzili: 300 piksel
              if (dist < 300) {
                lightIntensity = Math.max(lightIntensity, 1 - dist/300);
              }
            }
          });
          // Renk interpolasyonu (TCX özel efekt)
          if (player.name === "Asım/Burak") {
            if (player.currentMode === 1) {
              playerColor = interpolateColor("#FFA500", "#40E0D0", lightIntensity);
            } else {
              playerColor = interpolateColor("#808080", "#40E0D0", lightIntensity);
            }
          } else {
            playerColor = interpolateColor(player.originalColor, "#40E0D0", lightIntensity);
          }
        }
        
        if (player.wasHit) {
          game.ctx.fillStyle = 'white';
          player.wasHit = false;
        } else {
          game.ctx.fillStyle = playerColor;
        }
        
        game.ctx.beginPath();
        game.ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
        game.ctx.fill();
        
        // Can çubuğunu çiz
        const healthPercent = player.health / player.maxHealth;
        game.ctx.fillStyle = healthPercent > 0.5 ? 'green' : healthPercent > 0.2 ? 'yellow' : 'red';
        game.ctx.fillRect(
          player.x - player.size,
          player.y - player.size - 10,
          player.size * 2 * healthPercent,
          5
        );
        
        // TCX aktifse gölge çiz
        if (tcxEnabled) {
          game.ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
          game.ctx.beginPath();
          game.ctx.ellipse(player.x + 5, player.y + player.size + 5, player.size * 0.8, player.size * 0.3, 0, 0, Math.PI * 2);
          game.ctx.fill();
        }
      });
      
      // Mermileri çiz
      game.ctx.fillStyle = 'white';
      game.bullets.forEach(bullet => {
        // TCX için mermi renk ve gölge efektleri
        if (tcxEnabled) {
          let lightIntensity = 0;
          blocks.forEach(block => {
            if (block.type === "LIGHT") {
              const blockCenterX = block.x + BLOCK_SIZE/2;
              const blockCenterY = block.y + BLOCK_SIZE/2;
              const dx = bullet.x - blockCenterX;
              const dy = bullet.y - blockCenterY;
              const dist = Math.sqrt(dx*dx + dy*dy);
              if (dist < 300) {
                lightIntensity = Math.max(lightIntensity, 1 - dist/300);
              }
            }
          });
          
          // Mermi rengini ayarla
          game.ctx.fillStyle = interpolateColor("#FFFFFF", "#40E0D0", lightIntensity);
          
          // Mermi gölgesi çiz
          game.ctx.fillStyle = 'rgba(0,0,0,0.3)';
          game.ctx.beginPath();
          game.ctx.ellipse(bullet.x+5, bullet.y+5, bullet.size * 0.8, bullet.size * 0.3, 0, 0, Math.PI*2);
          game.ctx.fill();
          
          game.ctx.fillStyle = interpolateColor("#FFFFFF", "#40E0D0", lightIntensity);
        } else {
          game.ctx.fillStyle = 'white';
        }
        
        game.ctx.beginPath();
        game.ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2);
        game.ctx.fill();
      });
      
      // Asım'ın bıçak saldırılarını çiz
      game.slashes.forEach(slash => {
        const player = game.players[slash.player];
        
        // TCX için efektler
        if (tcxEnabled) {
          let lightIntensity = 0;
          blocks.forEach(block => {
            if (block.type === "LIGHT") {
              const blockCenterX = block.x + BLOCK_SIZE/2;
              const blockCenterY = block.y + BLOCK_SIZE/2;
              const dx = slash.x - blockCenterX;
              const dy = slash.y - blockCenterY;
              const dist = Math.sqrt(dx*dx + dy*dy);
              if (dist < 300) {
                lightIntensity = Math.max(lightIntensity, 1 - dist/300);
              }
            }
          });
          
          // Saldırı rengini ayarla
          game.ctx.fillStyle = interpolateColor("#FFA500", "#40E0D0", lightIntensity);
          
          // Saldırı gölgesi çiz
          game.ctx.fillStyle = 'rgba(0,0,0,0.3)';
          game.ctx.beginPath();
          game.ctx.ellipse(slash.x+5, slash.y+5, slash.size * 0.8, slash.size * 0.3, slash.angle, 0, Math.PI*2);
          game.ctx.fill();
          
          game.ctx.fillStyle = interpolateColor("#FFA500", "#40E0D0", lightIntensity);
        } else {
          game.ctx.fillStyle = "#FFA500";
        }
        
        game.ctx.beginPath();
        game.ctx.arc(slash.x, slash.y, slash.size, 0, Math.PI * 2);
        game.ctx.fill();
      });
    }

    // Oyunu bitir
    function endGame(winnerIndex) {
      game.gameActive = false;
      document.getElementById('winnerText').textContent = `Oyuncu ${winnerIndex + 1} Kazandı!`;
      document.getElementById('gameOverScreen').style.display = 'flex';
    }

    // Oyunu yeniden başlat
    function restartGame() {
      // Oyun durumunu temizle
      game.players = [];
      game.bullets = [];
      game.slashes = [];
      
      // Bilgi elementlerini kaldır
      document.querySelectorAll('.player-info').forEach(el => el.remove());
      
      // Oyun sonu ekranını gizle
      document.getElementById('gameOverScreen').style.display = 'none';
      
      // Karakter seçim ekranını göster
      document.getElementById('selectScreen').style.display = 'flex';
      
      // Mobil kontrolleri gizle
      if (deviceType !== 'desktop') {
        document.querySelector('.mobile-controls').style.display = 'none';
        document.querySelectorAll('.ulti-btn').forEach(btn => {
          btn.style.display = 'none';
        });
        document.querySelectorAll('.fire-btn').forEach(btn => {
          btn.style.display = 'none';
        });
      }
    }

    function drawBackground(ctx, width, height) {
      const tileSize = fpsBoosterEnabled ? 120 : 80; // FPS arttırıcı açıksa daha büyük kareler
      for (let y = 0; y < height; y += tileSize) {
        for (let x = 0; x < width; x += tileSize) {
          ctx.fillStyle = (x / tileSize + y / tileSize) % 2 === 0 ? '#333' : '#444';
          ctx.fillRect(x, y, tileSize, tileSize);
        }
      }
    }

    // Oyun yüklendiğinde başlat
    window.addEventListener('load', init);

    // Ayarlar için TCX toggle
    document.addEventListener("DOMContentLoaded", () => {
      const toggleFPSButton = document.getElementById("toggleFPS");
      
      if (toggleFPSButton) {
        toggleFPSButton.addEventListener("click", function() {
          fpsBoosterEnabled = !fpsBoosterEnabled;
          this.textContent = fpsBoosterEnabled ? "AÇIK" : "KAPALI";
          this.style.background = fpsBoosterEnabled ? "linear-gradient(to right, #4CAF50, #8BC34A)" : "linear-gradient(to right, #f44336, #e57373)";
          
          // Optimizasyonları uygula
          if (fpsBoosterEnabled) {
            // Daha az yüzen nesne
            createFloatingObjects();
            
            // Daha büyük arkaplan kareleri
            if (game.ctx) {
              drawBackground(game.ctx, config.width, config.height);
            }
          } else {
            // Orijinal ayarlara dön
            createFloatingObjects();
            if (game.ctx) {
              drawBackground(game.ctx, config.width, config.height);
            }
          }
        });
        
        // Mobil cihazlar için touch event ekle
        toggleFPSButton.addEventListener('touchstart', function(e) {
          e.preventDefault();
          this.click();
        }, { passive: false });
      }
      
      const gameCanvas = document.getElementById('gameCanvas');
      const graphicsSelect = document.getElementById('graphicsLevel');
      
      if (graphicsSelect) {
        graphicsSelect.addEventListener('change', function () {
          const value = this.value;
          gameCanvas.style.filter = "none";
          gameCanvas.style.transform = "none";
          document.body.style.background = "#111";
          if (value === "medium") {
            gameCanvas.style.filter = "drop-shadow(0 0 10px rgba(0,255,0,0.2)) saturate(1.3)";
            document.body.style.background = "#0b1a1f";
          } else if (value === "ultra") {
            gameCanvas.style.filter = "drop-shadow(0 0 15px rgba(0,255,255,0.4)) contrast(1.2) brightness(1.1)";
            document.body.style.background = "linear-gradient(to bottom right, #111, #1f1f1f)";
            gameCanvas.style.transform = "perspective(1200px) rotateX(3deg)";
            // Karakterleri kutu+top gibi 3D efektiyle göster
            document.querySelectorAll('.select-avatar').forEach(el => {
              el.style.borderRadius = '50%';
              el.style.boxShadow = 'inset 0 0 10px rgba(255,255,255,0.2), 0 5px 15px rgba(0,0,0,0.6)';
              el.style.border = '4px solid #aaa';
              el.style.backgroundImage = 'radial-gradient(circle at 30% 30%, #fff, ' + el.style.backgroundColor + ')';
              el.style.transform = 'translateY(-5px)';
            });
            document.querySelectorAll('.character').forEach(el => {
              el.style.boxShadow = '0 10px 25px rgba(0,0,0,0.4)';
              el.style.transform = 'perspective(800px) rotateX(8deg)';
            });
          }
        });
      }
    });
  
    document.addEventListener('click', (e) => {
      const target = e.target.closest('.character-card');
      if (target && target.querySelector('.character-avatar.Halk')) {
        const audio = document.getElementById('halkSound');
        if (audio) audio.play();
      }
    });

  </script>

  <audio id="halkSound" src="Zıpla.mp3"></audio>
</body>
</html>